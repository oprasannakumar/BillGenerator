<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Bill Builder</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- jsPDF CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f5f5f5;
  padding:20px;
  display:flex;
  justify-content:center;
}

.container{
  width:100%;
  max-width:520px;
  background:#fff;
  padding:18px;
  border-radius:8px;
  box-shadow:0 0 10px rgba(0,0,0,.1);
}

/* ---------- FORM ---------- */
label{
  font-size:13px;
  font-weight:600;
  display:block;
  margin-top:12px;
}

select,
input{
  width:100%;
  height:38px;
  padding:0 8px;
  border-radius:4px;
  border:1px solid #ccc;
  font-size:14px;
  background:#fff;
  box-sizing:border-box;
  line-height:38px;
  color:#000;
}

input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button{
  -webkit-appearance:none;
}
input[type=number]{ -moz-appearance:textfield; }

select{
  -webkit-appearance:none;
  appearance:none;
}

/* GRID */
.item-row{
  display:grid;
  grid-template-columns: 1.6fr 0.7fr 0.7fr 36px;
  gap:8px;
  align-items:center;
  margin-top:10px;
}

.item-total{
  font-weight:bold;
  text-align:right;
}

.delete-btn{
  background:#dc3545;
  color:#fff;
  border:none;
  border-radius:4px;
  height:36px;
  cursor:pointer;
}

/* BUTTONS */
button{
  width:100%;
  height:40px;
  margin-top:14px;
  border:none;
  border-radius:4px;
  cursor:pointer;
  font-size:14px;
}

.add-btn{background:#28a745;color:#fff}
.gen-btn{background:#007bff;color:#fff}
.back-btn{background:#6c757d;color:#fff}
.save-btn{background:#17a2b8;color:#fff}

/* ---------- BILL VIEW ---------- */
.bill-row{
  display:flex;
  justify-content:space-between;
  margin-top:6px;
}

.bill-grand{
  font-weight:bold;
  font-size:18px;
  margin-top:10px;
}

.hidden{display:none}
</style>
</head>

<body>

<!-- ================= BUILDER VIEW ================= -->
<div class="container" id="builderView">

  <label>Select Dealer</label>
  <select id="dealerSelect" onchange="loadItems()">
    <option value="">-- Select Dealer --</option>
  </select>

  <div id="itemsContainer"></div>

  <button class="add-btn" onclick="addItem()">âž• Add Item</button>
  <button class="gen-btn" onclick="generateBill()">Generate Bill</button>

</div>

<!-- ================= BILL VIEW ================= -->
<div class="container hidden" id="billView">

  <div id="billContent"></div>

  <button class="save-btn" onclick="savePDF()">ðŸ’¾ Save as PDF</button>
  <button class="back-btn" onclick="goBack()">â¬… Back</button>

</div>

<script>
const API_URL =
"https://script.google.com/macros/s/AKfycbzRt_ad2rXgZNVO4_Nlumm8EAxN7jcG7gG1y0yKEec7WXnws68ygcAqrhCjRzcmdWzl/exec";
const API_KEY = "9848o22338B!";

let groceries = {};
let dealerItems = [];
let finalBill = [];
let finalDealer = "";
let finalGrand = 0;

window.onload = () => {
  fetch(`${API_URL}?key=${API_KEY}`)
    .then(r => r.json())
    .then(d => {
      groceries = d || {};
      populateDealers();
    });
};

function populateDealers(){
  const set = new Set();
  Object.values(groceries).forEach(a =>
    a.forEach(d => set.add(d.dealer))
  );
  [...set].sort().forEach(d =>
    dealerSelect.add(new Option(d, d))
  );
}

function loadItems(){
  itemsContainer.innerHTML = "";
  dealerItems = [];
  const dealer = dealerSelect.value;
  if(!dealer) return;

  Object.keys(groceries).forEach(item => {
    groceries[item].forEach(d => {
      if(d.dealer === dealer){
        dealerItems.push({ item, price: d.price });
      }
    });
  });

  dealerItems.sort((a,b)=>a.item.localeCompare(b.item));
}

function addItem(){
  if(!dealerItems.length) return;

  const row = document.createElement("div");
  row.className = "item-row";

  const sel = document.createElement("select");
  sel.innerHTML =
    `<option value="">Item</option>` +
    dealerItems.map(i =>
      `<option value="${i.item}" data-price="${i.price}">${i.item}</option>`
    ).join("");

  const qty = document.createElement("input");
  qty.type = "number";
  qty.min = "0";
  qty.placeholder = "Qty";

  const total = document.createElement("div");
  total.className = "item-total";
  total.textContent = "â‚¹0";

  const del = document.createElement("button");
  del.textContent = "ðŸ—‘";
  del.className = "delete-btn";
  del.onclick = () => row.remove();

  function recalc(){
    const price = Number(sel.selectedOptions[0]?.dataset.price || 0);
    const q = Number(qty.value || 0);
    total.textContent = `â‚¹${price * q}`;
  }

  sel.onchange = recalc;
  qty.oninput = recalc;

  row.append(sel, qty, total, del);
  itemsContainer.appendChild(row);
}

function generateBill(){
  finalBill = [];
  finalGrand = 0;
  finalDealer = dealerSelect.value;

  document.querySelectorAll(".item-row").forEach(r => {
    const sel = r.children[0];
    const qty = Number(r.children[1].value);
    if(!sel.value || !qty) return;

    const price = Number(sel.selectedOptions[0].dataset.price);
    const total = qty * price;
    finalGrand += total;

    finalBill.push({ item: sel.value, qty, price, total });
  });

  if(!finalBill.length) return;

  billContent.innerHTML = `
    <h2 style="text-align:center">Invoice</h2>
    <div><b>Dealer:</b> ${finalDealer}</div>
    <div><b>Date:</b> ${new Date().toLocaleDateString()}</div>
    <hr>
    ${finalBill.map(b => `
      <div class="bill-row">
        <span>${b.item} (${b.qty} Ã— â‚¹${b.price})</span>
        <span>â‚¹${b.total}</span>
      </div>
    `).join("")}
    <hr>
    <div class="bill-row bill-grand">
      <span>Grand Total</span>
      <span>â‚¹${finalGrand}</span>
    </div>
  `;

  builderView.classList.add("hidden");
  billView.classList.remove("hidden");
}

function goBack(){
  billView.classList.add("hidden");
  builderView.classList.remove("hidden");
}

/* -------- PDF GENERATION -------- */
function savePDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  let y = 15;
  doc.setFontSize(16);
  doc.text("Invoice", 105, y, { align: "center" });
  y += 10;

  doc.setFontSize(11);
  doc.text(`Dealer: ${finalDealer}`, 10, y); y += 6;
  doc.text(`Date: ${new Date().toLocaleDateString()}`, 10, y); y += 8;

  doc.line(10, y, 200, y); y += 6;

  finalBill.forEach(b => {
    doc.text(`${b.item} (${b.qty} x ${b.price})`, 10, y);
    doc.text(`â‚¹${b.total}`, 190, y, { align: "right" });
    y += 6;
  });

  y += 4;
  doc.line(10, y, 200, y); y += 8;

  doc.setFontSize(13);
  doc.text("Grand Total", 10, y);
  doc.text(`â‚¹${finalGrand}`, 190, y, { align: "right" });

  const name = `Invoice_${finalDealer}_${Date.now()}.pdf`;
  doc.save(name);
}
</script>

</body>
</html>}

.item-total{
  font-weight:bold;
  text-align:right;
}

.delete-btn{
  background:#dc3545;
  color:#fff;
  border:none;
  border-radius:4px;
  height:36px;
  cursor:pointer;
}

/* BUTTONS */
button{
  width:100%;
  height:40px;
  margin-top:14px;
  border:none;
  border-radius:4px;
  cursor:pointer;
  font-size:14px;
}

.add-btn{background:#28a745;color:#fff}
.gen-btn{background:#007bff;color:#fff}
.back-btn{background:#6c757d;color:#fff}
.save-btn{background:#17a2b8;color:#fff}

/* ---------- BILL VIEW ---------- */
.bill-row{
  display:flex;
  justify-content:space-between;
  margin-top:6px;
}

.bill-grand{
  font-weight:bold;
  font-size:18px;
  margin-top:10px;
}

.hidden{display:none}
</style>
</head>

<body>

<!-- ================= BUILDER VIEW ================= -->
<div class="container" id="builderView">

  <label>Select Dealer</label>
  <select id="dealerSelect" onchange="loadItems()">
    <option value="">-- Select Dealer --</option>
  </select>

  <div id="itemsContainer"></div>

  <button class="add-btn" onclick="addItem()">âž• Add Item</button>
  <button class="gen-btn" onclick="generateBill()">Generate Bill</button>

</div>

<!-- ================= BILL VIEW ================= -->
<div class="container hidden" id="billView">

  <div id="billContent"></div>

  <button class="save-btn" onclick="savePDF()">ðŸ’¾ Save as PDF</button>
  <button class="back-btn" onclick="goBack()">â¬… Back</button>

</div>

<script>
const API_URL =
"https://script.google.com/macros/s/AKfycbzRt_ad2rXgZNVO4_Nlumm8EAxN7jcG7gG1y0yKEec7WXnws68ygcAqrhCjRzcmdWzl/exec";
const API_KEY = "9848o22338B!";

let groceries = {};
let dealerItems = [];
let finalBill = [];
let finalDealer = "";
let finalGrand = 0;

window.onload = () => {
  fetch(`${API_URL}?key=${API_KEY}`)
    .then(r => r.json())
    .then(d => {
      groceries = d || {};
      populateDealers();
    });
};

function populateDealers(){
  const set = new Set();
  Object.values(groceries).forEach(a =>
    a.forEach(d => set.add(d.dealer))
  );
  [...set].sort().forEach(d =>
    dealerSelect.add(new Option(d, d))
  );
}

function loadItems(){
  itemsContainer.innerHTML = "";
  dealerItems = [];
  const dealer = dealerSelect.value;
  if(!dealer) return;

  Object.keys(groceries).forEach(item => {
    groceries[item].forEach(d => {
      if(d.dealer === dealer){
        dealerItems.push({ item, price: d.price });
      }
    });
  });

  dealerItems.sort((a,b)=>a.item.localeCompare(b.item));
}

function addItem(){
  if(!dealerItems.length) return;

  const row = document.createElement("div");
  row.className = "item-row";

  const sel = document.createElement("select");
  sel.innerHTML =
    `<option value="">Item</option>` +
    dealerItems.map(i =>
      `<option value="${i.item}" data-price="${i.price}">${i.item}</option>`
    ).join("");

  const qty = document.createElement("input");
  qty.type = "number";
  qty.min = "0";
  qty.placeholder = "Qty";

  const total = document.createElement("div");
  total.className = "item-total";
  total.textContent = "â‚¹0";

  const del = document.createElement("button");
  del.textContent = "ðŸ—‘";
  del.className = "delete-btn";
  del.onclick = () => row.remove();

  function recalc(){
    const price = Number(sel.selectedOptions[0]?.dataset.price || 0);
    const q = Number(qty.value || 0);
    total.textContent = `â‚¹${price * q}`;
  }

  sel.onchange = recalc;
  qty.oninput = recalc;

  row.append(sel, qty, total, del);
  itemsContainer.appendChild(row);
}

function generateBill(){
  finalBill = [];
  finalGrand = 0;
  finalDealer = dealerSelect.value;

  document.querySelectorAll(".item-row").forEach(r => {
    const sel = r.children[0];
    const qty = Number(r.children[1].value);
    if(!sel.value || !qty) return;

    const price = Number(sel.selectedOptions[0].dataset.price);
    const total = qty * price;
    finalGrand += total;

    finalBill.push({ item: sel.value, qty, price, total });
  });

  if(!finalBill.length) return;

  billContent.innerHTML = `
    <h2 style="text-align:center">Invoice</h2>
    <div><b>Dealer:</b> ${finalDealer}</div>
    <div><b>Date:</b> ${new Date().toLocaleDateString()}</div>
    <hr>
    ${finalBill.map(b => `
      <div class="bill-row">
        <span>${b.item} (${b.qty} Ã— â‚¹${b.price})</span>
        <span>â‚¹${b.total}</span>
      </div>
    `).join("")}
    <hr>
    <div class="bill-row bill-grand">
      <span>Grand Total</span>
      <span>â‚¹${finalGrand}</span>
    </div>
  `;

  builderView.classList.add("hidden");
  billView.classList.remove("hidden");
}

function goBack(){
  billView.classList.add("hidden");
  builderView.classList.remove("hidden");
}

/* -------- PDF GENERATION -------- */
function savePDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  let y = 15;
  doc.setFontSize(16);
  doc.text("Invoice", 105, y, { align: "center" });
  y += 10;

  const now = new Date();

  const dateStr = now.toLocaleDateString("en-GB");
  const timeStr = now
    .toLocaleTimeString("en-GB")
    .replace(/:/g, "-");

  doc.setFontSize(11);
  doc.text(`Dealer: ${finalDealer}`,
</script>

</body>
</html>
